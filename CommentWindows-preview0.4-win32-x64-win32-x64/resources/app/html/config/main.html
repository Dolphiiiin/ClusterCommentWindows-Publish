<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Comment Windows</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css" />
    <link rel="stylesheet" href="../index.html.css">
    <link rel="stylesheet" href="../comment.html.css">

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="js/bouyomichan_client.js"></script>

    <script>
        function urlopen(url){
            const {shell} = require('electron');
            shell.openExternal(url);
        }
    </script>
</head>
<body id="body">



<footer>
    <details class="box" id="footer">
        <summary>設定</summary>
        <div class="control">
            <h1 class="title is-4">詳細設定</h1>
            <div class="control box">
                <h1 class="title is-5">棒読みちゃん連携</h1>
                <div class="control box">
                    <label class="checkbox">
                        <input type="checkbox" class="checkbox" onclick="bouyomiSetting()" id="bouyomiSetting">棒読みちゃん連携をオンにする
                    </label>
                    <p>棒読みちゃんに <a href="https://github.com/ryujimiya/Plugin_BymChnWebSocket">WebSocketプラグイン</a>が導入されている必要があります</p>
                    <label class="box">
                        <h1 class="title is-5">Prefixの設定</h1>
                        <p>設定した文字が先頭になっているコメントのみ読み上げます</p>
                        <input class="input is-small" placeholder="空欄の場合はすべてのテキストを読み上げます" id="bouyomiPrefix">
                    </label>

                    <script>
                        function bouyomiSetting(){
                            let val = document.getElementById("bouyomiSetting");

                        }
                    </script>
                </div>
            </div>
            <h1 class="title is-4">デバック</h1>
            <div class="control box">
                <label>
                    <a class="button is-large is-fullwidth" onclick="kill()">Calciteを再起動</a>
                </label>
            </div>
        </div>
    </details>
</footer>

<script>

    const child_process = require('child_process');
    // let val = document.getElementById("bouyomiSetting");
    // const bouyomi = val.checked;
    val = document.getElementById("bouyomiPrefix");
    // const  bouyomiPrefix = String(val.value);
    console.log(String(document.getElementById("bouyomiSetting").checked) + "  " + document.getElementById("bouyomiPrefix").value)

    let ul = document.createElement('ul');
    ul.id = "comment-column";




    document.body.appendChild(ul);
    let fragment = document.createDocumentFragment();
    let child1 = document.createElement('li'),
        child2 = document.createElement('div'),
        child3 = document.createElement('img'),
        child4 = document.createElement('p'),
        child5 = document.createElement('a'),
        child6 = document.createElement('p'),
        child7 = document.createElement('p')
    ;



    console.log("start process")
    let child = child_process.spawn("Calcite2.exe", []);

    let match,
        scrape = [],
        i = 0,
        ii,
        regex,
        talkText,
        json,
        jsonParse,
        _json
    ;

    let bouyomiChanClient = new BouyomiChanClient();
    child.stdout.setEncoding('utf8');
    child.stdout.on('data', function(data) {
        data = data.replace(/\s+/g, "");
        console.log("HEX:\n"+data)
        if(data.length != 2) {
            data = Buffer.from(data, 'hex').toString('utf-8');

            json = data.match(/\{[\s\S]*?\}[\s\S]*?\}/g);

            for (ii=0; ii<json.length; ii++){
                console.log(json)
                jsonParse = String("");
                jsonParse = JSON.parse(json[ii]);
                scrape = [
                    jsonParse.commentedBy.username,
                    jsonParse.commentedBy.displayName,
                    jsonParse.commentedBy.photoUrl,
                    jsonParse.body,
                    jsonParse.createdAt
                ]
                console.log("JSON:\n" + json[ii])
                console.log("\u001b[32musername: \u001b[34m" + jsonParse.commentedBy.username + "\n\u001b[32mdisplayName: \u001b[34m" + jsonParse.commentedBy.displayName + "\n\u001b[32mphotoUrl: \u001b[34m" + jsonParse.commentedBy.photoUrl + "\n\u001b[32mbody: \u001b[34m" + jsonParse.body + "\n\u001b[32mcreatedAt: \u001b[34m" + jsonParse.createdAt);


                child1 = document.createElement('li'),
                    child2 = document.createElement('div'),
                    child3 = document.createElement('img'),
                    child4 = document.createElement('p'),
                    child5 = document.createElement('a'),
                    child6 = document.createElement('p'),
                    child7 = document.createElement('p')
                ;

                child1.className = "control box commentColumn";
                child1.id = "li" + String(i);

                child2.className = "user";
                child2.id = "div" + String(i);

                child3.className = "userValue user-icon";
                child3.src = scrape[2];

                child4.className = "userValue userID tag is-primary";
                child4.innerText = scrape[1];

                child5.className = "userValue userID tag is-primary is-light";
                child5.target = "_blank";
                child5.href = "https://cluster.mu/u/" + scrape[0];
                child5.innerText = scrape[0];

                child6.className = "userValue userID tag is-light";
                child6.innerText = scrape[4];

                child7.className = "title is-6";
                child7.innerHTML = scrape[3].replaceAll("\\n","<br>");

                element = document.getElementById("comment-column");
                element.prepend(child1);
                element = document.getElementById("li" + String(i));
                element.appendChild(child2);
                element.appendChild(child7);
                element = document.getElementById("div" + String(i));
                element.appendChild(child3);
                element.appendChild(child4);
                element.appendChild(child5);
                element.appendChild(child6);


                if (document.getElementById("bouyomiSetting").checked == true) {
                    if (document.getElementById("bouyomiPrefix").value == "") {
                        talkText = scrape[3].replaceAll("<br>", "");
                        bouyomiChanClient.talk(talkText);
                    }else if(scrape[3].substr(0,document.getElementById("bouyomiPrefix").value.length) == document.getElementById("bouyomiPrefix").value) {
                        talkText = scrape[3].replaceAll("<br>", "");
                        talkText = scrape[3].slice(bouyomiPrefix.length);
                        bouyomiChanClient.talk(talkText);
                    }
                }

                element = document.getElementById("comment-column");
                i++;
                scrape = [];
            }
        }
    });
    function kill(){
        child.kill();
        location.reload();
    }
</script>
</body>
</html>